<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Goutte – Visualisation interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Précharge la skybox -->
  <link rel="preload" as="image" href="./multi_nebulae_1.png" />

  <!-- model-viewer -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>

  <style>
    html,body{height:100%;margin:0;background:transparent;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{position:relative;width:100%;height:100%;min-height:320px;background:transparent}
    model-viewer{width:100%;height:100%;background-color:transparent;--poster-color:transparent}
    .controls{position:absolute;top:12px;left:12px;display:flex;gap:8px;flex-wrap:wrap;
      padding:10px 12px;background:rgba(20,20,20,.6);color:#fff;border-radius:12px;
      backdrop-filter:blur(8px);z-index:5}
    .controls label{font-size:14px;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .controls select,.controls input[type=checkbox]{accent-color:#999;background:#111;color:#fff;
      border:1px solid #444;border-radius:8px;padding:6px 8px;font-size:14px}
    .controls select{min-width:240px}
    .footer{position:absolute;left:12px;bottom:12px;z-index:5}
    .btn{border:1px solid #444;border-radius:999px;padding:8px 12px;background:rgba(20,20,20,.6);color:#fff;font-size:13px;cursor:pointer}
    .btn:hover{border-color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <label>
        <span>Configuration</span>
        <select id="cfg">
          <option value="full" selected>Fermée – goutte complète</option>
          <option value="open">Ouverte – coque du bas + mandorle</option>
          <option value="top">Couvercle – partie haute</option>
        </select>
      </label>

      <label><input type="checkbox" id="toggleSky" checked> Galaxie</label>
    </div>

    <div class="footer">
      <button id="reset" class="btn" type="button">Réinitialiser la vue</button>
    </div>

    <!-- Viewer -->
    <model-viewer id="mv"
      src="https://ericpringels.github.io/3dfiles/goutte59c_XL.glb"
      camera-controls touch-action="pan-y"
      style="background-color:transparent"
      alt="Urne goutte – visualisation 3D"
      tone-mapping="aces"
      camera-orbit="30deg 60deg auto"
      camera-target="auto"
      field-of-view="55deg"
      scale="0.55 0.55 0.55"
      exposure="2.4"
      environment-intensity="2.5"
      shadow-intensity="0.3"
    >
      <!-- Éclairage directionnel -->
      <directional-light color="#ffffff" intensity="1.2" direction="1 1 1"></directional-light>
      <directional-light color="#ffffff" intensity="0.8" direction="-1 0.5 -0.5"></directional-light>
      <directional-light color="#ffffff" intensity="0.6" direction="0 -1 0.5"></directional-light>
    </model-viewer>
  </div>

  <script>
    const mv = document.getElementById('mv');
    const cfg = document.getElementById('cfg');
    const tSky = document.getElementById('toggleSky');
    const btnR = document.getElementById('reset');

    const URLS = {
      full: "https://ericpringels.github.io/3dfiles/goutte59c_XL.glb",
      open: "https://ericpringels.github.io/3dfiles/goutte59c_XL_bas.glb",
      top : "https://ericpringels.github.io/3dfiles/goutte59c_XL_haut.glb"
    };

    const GALAXY_URL = "./multi_nebulae_1.png";

    const ISO = { orbit:"30deg 60deg auto", target:"auto", fov:"55deg" };
    function applyIso(){ mv.cameraOrbit=ISO.orbit; mv.cameraTarget=ISO.target; mv.fieldOfView=ISO.fov; }

    function waitLoad(){
      if (mv.model) return Promise.resolve();
      return new Promise(res => { const onL=()=>{mv.removeEventListener('load',onL);res();}; mv.addEventListener('load',onL); });
    }

    function tweenExposure(from, to, ms=500){
      const start = performance.now();
      mv.exposure = from;
      function step(t){
        const p = Math.min((t - start)/ms, 1);
        mv.exposure = from + (to - from) * p;
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function applySkybox(on){
      if (on) {
        mv.setAttribute('skybox-image', GALAXY_URL);
        mv.setAttribute('environment-image', GALAXY_URL);
        mv.environmentIntensity = 3.5;
        tweenExposure(mv.exposure ?? 2.4, 2.8, 400);
      } else {
        mv.removeAttribute('skybox-image');
        mv.setAttribute('environment-image', 'neutral');
        mv.environmentIntensity = 1.5;
        tweenExposure(mv.exposure ?? 2.4, 1.4, 400);
      }
    }

    cfg.addEventListener('change', async ()=>{
      mv.src = URLS[cfg.value] || URLS.full;
      await mv.updateComplete; await waitLoad();
      applyIso(); applySkybox(tSky.checked);
    });

    tSky.addEventListener('change', ()=> applySkybox(tSky.checked));
    btnR.addEventListener('click', applyIso);

    mv.addEventListener('load', ()=>{
      applyIso();
    });

    (async ()=>{
      await waitLoad();
      mv.exposure = 2.4;
      mv.environmentIntensity = 2.5;
      applySkybox(true);
    })();
  </script>
</body>
</html>
