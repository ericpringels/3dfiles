<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Goutte – Visualisation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer@3.4.0/dist/model-viewer-legacy.js"></script>
  <style>
    html,body{height:100%;margin:0;background:transparent;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{position:relative;width:100%;height:100%}
    model-viewer{position:relative;z-index:1;width:100%;height:100%;background-color:transparent;--poster-color:transparent}
    .controls{position:absolute;top:12px;left:12px;display:flex;gap:8px;flex-wrap:wrap;
      padding:10px 12px;background:rgba(20,20,20,.6);color:#fff;border-radius:12px;backdrop-filter:blur(8px);z-index:2}
    .controls label{font-size:14px;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .controls select,.controls input[type=checkbox]{accent-color:#999;background:#111;color:#fff;border:1px solid #444;border-radius:8px;padding:6px 8px;font-size:14px}
    .controls select{min-width:240px}
    .footer{position:absolute;left:12px;bottom:12px;z-index:2}
    .btn{border:1px solid #444;border-radius:999px;padding:8px 12px;background:rgba(20,20,20,.6);color:#fff;font-size:13px;cursor:pointer}
    .btn:hover{border-color:#666}
    model-viewer::part(default-hotspot){background:transparent;border:none}
    .dimtag{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:10px;
      background:rgba(0,0,0,.55);color:#fff;font-size:12px;box-shadow:0 1px 8px rgba(0,0,0,.35)}
    .tick{width:14px;height:2px;background:#fff;opacity:.9;border-radius:1px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls" role="group" aria-label="Contrôles">
      <label>
        <span>Configuration</span>
        <select id="cfg">
          <option value="full" selected>Fermée – goutte complète</option>
          <option value="open">Ouverte – coque du bas + mandorle</option>
          <option value="top">Couvercle – partie haute</option>
        </select>
      </label>
      <label><input type="checkbox" id="toggleDims"> Afficher les dimensions</label>
      <label><input type="checkbox" id="toggleNight" checked> Nuit</label>
    </div>

    <div class="footer">
      <button id="reset" class="btn" type="button">Réinitialiser la vue</button>
    </div>

    <model-viewer id="mv"
      src="https://ericpringels.github.io/3dfiles/goutte59c_XL.glb"
      alt="Urne goutte – visualisation 3D"
      camera-controls touch-action="pan-y" interaction-prompt="none"
      tone-mapping="aces"
      camera-orbit="30deg 60deg auto"
      camera-target="auto"
      field-of-view="55deg" min-field-of-view="35deg" max-field-of-view="85deg"
      scale="0.28 0.28 0.28"
      environment-image="neutral"
      environment-intensity="3.6"
      exposure="3.0"
      shadow-intensity="0.6" shadow-softness="0.9">
      <button class="dimtag" slot="hotspot-x-min" style="display:none"><span class="tick"></span><span class="label">X</span></button>
      <button class="dimtag" slot="hotspot-x-max" style="display:none"><span class="tick"></span><span class="label">X</span></button>
      <button class="dimtag" slot="hotspot-z-min" style="display:none"><span class="tick"></span><span class="label">Z</span></button>
      <button class="dimtag" slot="hotspot-z-max" style="display:none"><span class="tick"></span><span class="label">Z</span></button>
      <button class="dimtag" slot="hotspot-y-min" style="display:none"><span class="tick"></span><span class="label">Y</span></button>
      <button class="dimtag" slot="hotspot-y-max" style="display:none"><span class="tick"></span><span class="label">Y</span></button>
    </model-viewer>
  </div>

  <script>
    const mv       = document.getElementById('mv');
    const cfg      = document.getElementById('cfg');
    const tDims    = document.getElementById('toggleDims');
    const tNight   = document.getElementById('toggleNight');
    const btnR     = document.getElementById('reset');

    const MODELS = {
      full: "https://ericpringels.github.io/3dfiles/goutte59c_XL.glb",
      open: "https://ericpringels.github.io/3dfiles/goutte59c_XL_bas.glb",
      top : "https://ericpringels.github.io/3dfiles/goutte59c_XL_haut.glb"
    };

    function waitLoad(){
      return mv.model ? Promise.resolve() : new Promise(res=>mv.addEventListener('load',res,{once:true}));
    }
    function applyIso(){
      mv.cameraOrbit = "30deg 60deg auto";
      mv.fieldOfView = "55deg";
      mv.scale.set ? mv.scale.set(0.28,0.28,0.28) : mv.setAttribute('scale','0.28 0.28 0.28');
    }

    // === Mode "Nuit" (avec fond earth_space_360.png) ===
    function setNight(on){
      if(on){
        mv.setAttribute('skybox-image', "./earth_space_360.png");   // fond qui bouge
        mv.setAttribute('environment-image', 'neutral');            // lumière fiable
        mv.environmentIntensity = 4.8;
        mv.exposure = 3.6;
        mv.shadowIntensity = 0.0;                                   // AUCUNE ombre
        syncSkyboxToCamera();                                       // orientation initiale
      } else {
        mv.removeAttribute('skybox-image');
        mv.setAttribute('environment-image', 'neutral');
        mv.environmentIntensity = 3.6;
        mv.exposure = 3.0;
        mv.shadowIntensity = 0.6;                                   // ombres normales
      }
      try{ localStorage.setItem('nightEnabled', on ? '1' : '0'); }catch(e){}
    }

    // Fait tourner la skybox selon la caméra (réaliste)
    function syncSkyboxToCamera(){
      const o = mv.getCameraOrbit();               // radians
      mv.skyboxRotation = (-o.theta) + 'rad';      // rotation horizontale
    }
    mv.addEventListener('camera-change', ()=>{
      if (tNight.checked && mv.skyboxImage) syncSkyboxToCamera();
    });

    // === Dimensions (hotspots) ===
    function setHotspotsVisibility(on){
      mv.querySelectorAll('button[slot^="hotspot-"]').forEach(el=> el.style.display = on ? 'inline-flex' : 'none');
    }
    function placeDimensionHotspots(){
      if (!mv.model) return;
      const d = mv.getDimensions(); if(!d) return;
      const hx=d.x/2, hy=d.y/2, hz=d.z/2;
      const items = [
        ['hotspot-x-min',[-hx,0,0],`Largeur ${(d.x*100).toFixed(1)} cm`],
        ['hotspot-x-max',[ hx,0,0],`Largeur ${(d.x*100).toFixed(1)} cm`],
        ['hotspot-z-min',[0,0,-hz],`Profondeur ${(d.z*100).toFixed(1)} cm`],
        ['hotspot-z-max',[0,0, hz],`Profondeur ${(d.z*100).toFixed(1)} cm`],
        ['hotspot-y-min',[0,-hy,0],`Hauteur ${(d.y*100).toFixed(1)} cm`],
        ['hotspot-y-max',[0, hy,0],`Hauteur ${(d.y*100).toFixed(1)} cm`],
      ];
      items.forEach(([slot,pos,label])=>{
        const el = mv.querySelector(`[slot="${slot}"]`);
        if(!el) return;
        el.dataset.position = pos.join(' ');
        const lab = el.querySelector('.label'); if(lab) lab.textContent = label;
      });
      setHotspotsVisibility(tDims.checked);
    }

    // === Listeners ===
    cfg.addEventListener('change', async ()=>{
      mv.src = MODELS[cfg.value] || MODELS.full;
      await waitLoad(); applyIso(); placeDimensionHotspots(); setNight(tNight.checked);
    });
    tNight.addEventListener('change', ()=> setNight(tNight.checked));
    tDims.addEventListener('change', ()=> setHotspotsVisibility(tDims.checked));
    btnR.addEventListener('click', applyIso);

    // === Init ===
    (async ()=>{
      await waitLoad();
      applyIso();
      placeDimensionHotspots();
      setHotspotsVisibility(tDims.checked);
      const saved = (localStorage.getItem('nightEnabled')!=='0'); // par défaut: ON
      tNight.checked = saved;
      setNight(saved);
    })();
  </script>
<script>
(async function () {
  // 1) Attendre que <model-viewer> soit défini
  if (!customElements.get('model-viewer')) {
    await customElements.whenDefined('model-viewer');
  }

  const mv = document.getElementById('mv');
  const ALBEDO_URL = "./cratered-rock-albedo.png";
  const NORMAL_URL = "./cratered-rock-normal.png";

  // Utilitaire: charge une image et renvoie une Promise<texture>
  function loadTexture(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous"; // ok même origine; safe si CDN un jour
      img.onload = () => {
        try { resolve(mv.createTexture(img)); }
        catch (e) { reject(e); }
      };
      img.onerror = () => reject(new Error("Impossible de charger " + url));
      img.src = url + "?v=" + Date.now(); // cache-bust pour GitHub Pages
    });
  }

  async function applyAsteroidLook() {
    // 2) Attendre le modèle si pas prêt
    if (!mv.model) {
      await new Promise(res => mv.addEventListener('load', res, { once: true }));
    }

    // 3) Charger les textures
    let texBase = null, texNorm = null;
    try {
      [texBase, texNorm] = await Promise.all([
        loadTexture(ALBEDO_URL),
        loadTexture(NORMAL_URL)
      ]);
    } catch (err) {
      console.warn("[asteroid-texture] Échec chargement textures:", err);
      return;
    }

    // 4) Appliquer sur tous les matériaux
    const mats = mv.model?.materials || [];
    mats.forEach(mat => {
      const pbr = mat.pbrMetallicRoughness;
      if (pbr?.baseColorTexture) pbr.baseColorTexture.setTexture(texBase);
      // roche mate
      pbr?.setMetallicFactor?.(0.0);
      pbr?.setRoughnessFactor?.(0.95);

      if (mat.normalTexture && texNorm) {
        mat.normalTexture.setTexture(texNorm);
        // renforce un peu le relief
        try { mat.normalTexture.scale = 1.2; } catch {}
      }
    });

    // (Optionnel) un peu plus de lumière pour lire le relief
    mv.environmentIntensity = Math.max(3.6, mv.environmentIntensity || 3.6);
    mv.exposure = Math.max(3.2, mv.exposure || 3.2);

    console.log("[asteroid-texture] Appliqué sur", mats.length, "matériau(x)");
  }

  // 5) Première application
  applyAsteroidLook();

  // 6) Ré-application automatique après chaque changement de modèle
  mv.addEventListener('load', applyAsteroidLook);

  // 7) (Facultatif) ré-appliquer si tu as un <select id="cfg"> qui change mv.src
  const cfg = document.getElementById('cfg');
  if (cfg) cfg.addEventListener('change', () => {
    // rien ici: l'event 'load' ci-dessus relancera applyAsteroidLook quand le nouveau GLB est prêt
  });
})();
</script>
</body>
</html>

