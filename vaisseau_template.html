<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Goutte – Visualisation interactive</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>
<style>
html,body{height:100%;margin:0;background:transparent;font-family:Inter,sans-serif}
.wrap{position:relative;width:100%;height:100%}
model-viewer{width:100%;height:100%;--poster-color:transparent}
.controls{position:absolute;top:12px;left:12px;display:flex;gap:8px;flex-wrap:wrap;
  padding:10px 12px;background:rgba(20,20,20,.6);color:#fff;border-radius:12px;backdrop-filter:blur(8px);z-index:5}
label{font-size:14px;display:inline-flex;align-items:center;gap:6px}
select,input[type=checkbox]{accent-color:#999;background:#111;color:#fff;
  border:1px solid #444;border-radius:8px;padding:6px 8px;font-size:14px}
select{min-width:240px}
</style>
</head>
<body>
<div class="wrap">
  <div class="controls">
    <label>
      <span>Configuration</span>
      <select id="cfg">
        <option value="full" selected>Fermée – goutte complète</option>
        <option value="open">Ouverte – coque du bas + mandorle</option>
        <option value="top">Couvercle – partie haute</option>
      </select>
    </label>
    <label><input type="checkbox" id="toggleSky"> Galaxie</label>
  </div>

  <model-viewer id="mv"
    src="https://ericpringels.github.io/3dfiles/goutte59c_XL.glb"
    camera-controls
    camera-orbit="30deg 60deg auto"
    field-of-view="55deg"
    tone-mapping="aces"
    exposure="3.2"
    environment-image="neutral"
    environment-intensity="3.5"
    style="background-color:transparent"
    scale="0.38 0.38 0.38"
    shadow-intensity="0.6"
    shadow-softness="0.9">
  </model-viewer>
</div>

<script type="module">
const mv = document.getElementById('mv');
const tSky = document.getElementById('toggleSky');
const cfg  = document.getElementById('cfg');
const SKYBOX_URL = "./multi_nebulae_1.png";
const URLS = {
  full: "https://ericpringels.github.io/3dfiles/goutte59c_XL.glb",
  open: "https://ericpringels.github.io/3dfiles/goutte59c_XL_bas.glb",
  top : "https://ericpringels.github.io/3dfiles/goutte59c_XL_haut.glb"
};

// --- création de lumières via Three.js interne ---
mv.addEventListener('scene-graph-ready', () => {
  const scene = mv.scene; // scène Three.js interne
  // supprime toute lumière par défaut
  scene.children.filter(o=>o.isLight).forEach(l=>scene.remove(l));

  const THREE = mv.constructor.THREE;
  const hemi = new THREE.HemisphereLight(0xffffff,0x666666,1.2);
  scene.add(hemi);

  const key = new THREE.DirectionalLight(0xffffff,2.8);
  key.position.set(2,2,2);
  scene.add(key);

  const fill = new THREE.DirectionalLight(0xffffff,1.6);
  fill.position.set(-2,1,1);
  scene.add(fill);

  const back = new THREE.DirectionalLight(0xffffff,1.4);
  back.position.set(0,-1,-2);
  scene.add(back);

  const spot1 = new THREE.PointLight(0xffffff,100,10);
  spot1.position.set(0.5,0.5,0.5);
  scene.add(spot1);

  const spot2 = new THREE.PointLight(0xffccaa,80,10);
  spot2.position.set(-0.5,-0.2,0.3);
  scene.add(spot2);
});

// --- Skybox toggle + persistance ---
function applySkybox(on){
  if(on){
    mv.setAttribute('skybox-image', SKYBOX_URL);
    mv.environmentIntensity = 3.5;
    mv.exposure = 3.2;
  } else {
    mv.removeAttribute('skybox-image');
    mv.environmentIntensity = 3.5; // conserve la lumière
    mv.exposure = 3.2;
  }
  localStorage.setItem('galaxyEnabled', on ? '1':'0');
}
function restoreSky(){
  const s = localStorage.getItem('galaxyEnabled');
  tSky.checked = (s!=='0');
  applySkybox(tSky.checked);
}
tSky.addEventListener('change',()=>applySkybox(tSky.checked));

// --- changement de modèle ---
cfg.addEventListener('change',()=>{
  mv.src = URLS[cfg.value];
});

// --- init ---
restoreSky();
</script>
</body>
</html>
